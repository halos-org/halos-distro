#!/bin/bash

# Helper script for creating GitHub issues with proper workflow template
# Usage: ./create-issue feature "Title" "Description"
#    or: ./create-issue bug "Title" "Description"

set -e

TYPE="${1:-feature}"
TITLE="$2"
DESCRIPTION="$3"

if [[ -z "$TITLE" ]]; then
    echo "Usage: ./create-issue [feature|bug] \"Title\" \"Description\""
    echo "Example: ./create-issue feature \"Add user authentication\" \"Implement JWT-based auth\""
    exit 1
fi

# Set label based on type
if [[ "$TYPE" == "bug" ]]; then
    LABEL="type:bug"
    TEMPLATE="Bug Fix"
else
    LABEL="type:feature"
    TEMPLATE="Feature Implementation"
fi

# Create issue body with workflow reminder
BODY="## Description

${DESCRIPTION:-[Add description here]}

## Implementation Workflow

**IMPORTANT**: Follow [DEVELOPMENT_WORKFLOW.md](/DEVELOPMENT_WORKFLOW.md). Do NOT skip steps.

### Phase 1: Explore & Plan ⚠️ NO CODING YET!
1. **Explore**: Read all relevant files WITHOUT writing code
2. **Plan**: Use \`think hard\` to create detailed approach
3. **Document**: Comment your plan before proceeding

### Phase 2: Test-Driven Development
1. **Write Tests First**: Create comprehensive tests
2. **Verify Tests Fail**: Run tests to confirm they fail
3. **Commit Tests**: Commit tests before implementation
4. **Implement**: Write code to pass tests (don't modify tests)
5. **Iterate**: Run tests, fix issues, repeat until all pass
6. **Verify**: Use subagents to verify implementation
7. **Commit Implementation**: Commit once tests pass

## Test Scenarios

- [ ] Test case 1: [to be defined during planning]
- [ ] Test case 2: [to be defined during planning]
- [ ] Test case 3: [to be defined during planning]

## Acceptance Criteria

- [ ] All tests pass
- [ ] Matches \`/docs/SPEC.md\` requirements
- [ ] Follows \`/docs/ARCHITECTURE.md\` patterns
- [ ] No security vulnerabilities
- [ ] Documentation updated if needed

## References

- **Specification**: See \`/docs/SPEC.md\`
- **Architecture**: See \`/docs/ARCHITECTURE.md\`
- **Workflow Guide**: See \`/DEVELOPMENT_WORKFLOW.md\`

## Implementation Checklist

- [ ] Read issue completely
- [ ] Explore without coding first
- [ ] Write tests before implementation
- [ ] Follow TDD workflow
- [ ] Reference SPEC and ARCHITECTURE
- [ ] Use subagents for verification

---
⚠️ **Reminder**: Quality > Speed. Follow the workflow!"

# Check if template exists and use it
if [[ -f ".github/ISSUE_TEMPLATE/${TYPE}.md" ]]; then
    echo "Using template: .github/ISSUE_TEMPLATE/${TYPE}.md"
    gh issue create \
        --title "$TITLE" \
        --body "$BODY" \
        --label "$LABEL" \
        --template "$TEMPLATE"
else
    echo "Creating issue with workflow template..."
    gh issue create \
        --title "$TITLE" \
        --body "$BODY" \
        --label "$LABEL"
fi